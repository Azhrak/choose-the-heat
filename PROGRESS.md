# Project Progress & Implementation Plan

**Project**: Spicy Tales - AI-Enhanced Romance Novel App
**Last Updated**: 2025-11-03 (Added Multi-Provider AI Support)
**Current Phase**: Phase 3 Complete (Foundation + Docker + Multi-AI), Ready for Phase 4

üìÑ **Quick Reference:** See [SESSION_SUMMARY.md](SESSION_SUMMARY.md) for comprehensive session recap

---

## ‚úÖ Completed Work

### Phase 1: Foundation & Setup (100% Complete)

**Files Created:**

- [package.json](package.json) - Dependencies, scripts, and engine requirements configured
- [.nvmrc](.nvmrc) - Node 24 version specification for nvm
- [.node-version](.node-version) - Node 24 version for asdf/fnm
- [tsconfig.json](tsconfig.json) - TypeScript strict mode enabled
- [app.config.ts](app.config.ts) - TanStack Start configuration (deprecated, now uses vite.config.ts)
- [tailwind.config.js](tailwind.config.js) - Custom romance color palette
- [postcss.config.js](postcss.config.js) - PostCSS configuration
- [.env.example](.env.example) - Environment variable template
- [.gitignore](.gitignore) - Git ignore rules
- [src/styles/globals.css](src/styles/globals.css) - Global styles with Tailwind
- [src/lib/utils.ts](src/lib/utils.ts) - Utility functions (cn, formatError, etc.)

**Note:** The `app/` folder has been renamed to `src/` to match TanStack Start's expected structure.

**Key Decisions:**

- Using pnpm 9+ for package management
- Node.js 24+ for runtime
- TanStack Start for full-stack React framework
- Tailwind CSS for styling with custom romance theme
- TypeScript strict mode for maximum type safety

### Phase 2: Database Infrastructure (100% Complete)

**Files Created:**

- [src/lib/db/index.ts](src/lib/db/index.ts) - Kysely database client setup
- [src/lib/db/types.ts](src/lib/db/types.ts) - TypeScript types (generated by kysely-codegen)
- [src/lib/db/migrate.ts](src/lib/db/migrate.ts) - Migration runner script
- [src/lib/db/migrations/001_initial.ts](src/lib/db/migrations/001_initial.ts) - Initial schema
- [src/lib/db/seed.ts](src/lib/db/seed.ts) - Seed data with 4 novel templates

**Database Schema:**

```
users (id, email, name, avatar_url, default_preferences, email_verified, timestamps)
oauth_accounts (id, user_id, provider, provider_user_id, access_token, refresh_token, expires_at)
password_accounts (id, user_id, hashed_password, timestamps)
sessions (id, user_id, expires_at, created_at)
novel_templates (id, title, description, base_tropes[], estimated_scenes, cover_gradient, timestamps)
choice_points (id, template_id, scene_number, prompt_text, options[jsonb], created_at)
user_stories (id, user_id, template_id, preferences[jsonb], current_scene, status, timestamps)
choices (id, story_id, choice_point_id, selected_option, created_at)
scenes (id, story_id, scene_number, content, word_count, created_at)
```

**Seeded Templates:**

1. The CEO's Secret Arrangement (fake-dating, ceo-romance, enemies-to-lovers)
2. Moonlit Destiny (paranormal, fated-mates, forbidden-love)
3. Second Chance Summer (second-chance, small-town, childhood-friends)
4. The Highlander's Vow (time-travel, historical, forced-proximity)

**Available Scripts:**

- `pnpm db:migrate` - Run migrations
- `pnpm db:codegen` - Generate TypeScript types from schema
- `pnpm db:seed` - Seed novel templates

### Phase 3: Authentication System (100% Complete)

**Files Created:**

- [src/lib/auth/session.ts](src/lib/auth/session.ts) - Session management (create, validate, delete)
- [src/lib/auth/oauth.ts](src/lib/auth/oauth.ts) - Google OAuth with Arctic
- [src/lib/auth/password.ts](src/lib/auth/password.ts) - Argon2 password hashing and validation
- [src/lib/db/queries/users.ts](src/lib/db/queries/users.ts) - User database queries
- [src/routes/api/auth/google.ts](src/routes/api/auth/google.ts) - OAuth initiation
- [src/routes/api/auth/callback.google.ts](src/routes/api/auth/callback.google.ts) - OAuth callback
- [src/routes/api/auth/signup.ts](src/routes/api/auth/signup.ts) - Email/password signup
- [src/routes/api/auth/login.ts](src/routes/api/auth/login.ts) - Email/password login
- [src/routes/api/auth/logout.ts](src/routes/api/auth/logout.ts) - Logout endpoint
- [src/routes/auth/login.tsx](src/routes/auth/login.tsx) - Login page UI
- [src/routes/auth/signup.tsx](src/routes/auth/signup.tsx) - Signup page UI

**Authentication Features:**

- ‚úÖ Google OAuth integration (Arctic library)
- ‚úÖ Email/password authentication (Argon2 hashing)
- ‚úÖ Secure session management (httpOnly, SameSite, Secure cookies)
- ‚úÖ 30-day session expiry
- ‚úÖ Password strength validation
- ‚úÖ Account linking (OAuth + email for same user)
- ‚úÖ Beautiful login/signup UI with Google button

**Security Measures:**

- httpOnly cookies (prevent XSS)
- SameSite=Lax (CSRF protection)
- Secure flag for HTTPS
- Argon2 password hashing (memory-hard)
- State validation for OAuth (prevent CSRF)

### Phase 3.5: AI Integration (100% Complete)

**Files Created:**

- [src/lib/ai/client.ts](src/lib/ai/client.ts) - Vercel AI SDK client wrapper with OpenAI
- [src/lib/ai/prompts.ts](src/lib/ai/prompts.ts) - Prompt template builders
- [src/lib/ai/generate.ts](src/lib/ai/generate.ts) - Scene generation logic
- [src/lib/db/queries/stories.ts](src/lib/db/queries/stories.ts) - Story queries
- [src/lib/db/queries/scenes.ts](src/lib/db/queries/scenes.ts) - Scene queries

**AI Features:**

- ‚úÖ Vercel AI SDK integration with multiple providers
- ‚úÖ **4 AI providers supported:** OpenAI, Google Gemini, Anthropic Claude, Mistral AI
- ‚úÖ Provider-agnostic interface (easy to switch between providers)
- ‚úÖ Model customization per provider via environment variables
- ‚úÖ Built-in streaming support and error handling
- ‚úÖ Dynamic system prompts based on user preferences
- ‚úÖ Scene generation with context from previous scenes
- ‚úÖ Choice impact reflection in story
- ‚úÖ Story progression awareness (beginning, middle, climax, resolution)
- ‚úÖ Scene caching in database (avoid regeneration costs)
- ‚úÖ Validation for scene quality (word count, no placeholders)
- ‚úÖ Comprehensive provider documentation ([AI_PROVIDERS.md](AI_PROVIDERS.md))

**Prompt Template Features:**

- Adjusts for spice level (1-5 scale)
- Incorporates chosen tropes naturally
- Adjusts pacing (slow-burn vs fast-paced)
- Uses context from last 2 scenes
- Reflects previous choice impacts
- Sets up choice points naturally

### Phase 3.6: Core Routes (100% Complete)

**Files Created:**

- [src/router.tsx](src/router.tsx) - Router configuration
- [src/routes/\_\_root.tsx](src/routes/__root.tsx) - Root layout with React Query
- [src/routes/index.tsx](src/routes/index.tsx) - Landing page

**Note:** `client.tsx` and `ssr.tsx` were removed in the TanStack Start migration as they are no longer needed.

**Landing Page Features:**

- Hero section with call-to-action
- Feature showcase (3 cards)
- Links to signup/login
- Beautiful gradient background

### Phase 3.7: Docker Setup (100% Complete)

**Files Created:**

- [Dockerfile](Dockerfile) - Multi-stage build for optimal image size
- [docker-compose.yml](docker-compose.yml) - Orchestrates app, PostgreSQL, and Redis
- [docker-entrypoint.sh](docker-entrypoint.sh) - Runs migrations on startup
- [.dockerignore](.dockerignore) - Excludes unnecessary files from build
- [DOCKER.md](DOCKER.md) - Complete Docker setup documentation
- [.env.example](.env.example) - Unified environment template (works for both local & Docker)

**Docker Features:**

- ‚úÖ Multi-stage Dockerfile (deps ‚Üí builder ‚Üí runner)
- ‚úÖ PostgreSQL 14 with persistent volume
- ‚úÖ Redis 7 with persistent volume
- ‚úÖ Health checks for all services
- ‚úÖ Automatic migrations on startup
- ‚úÖ Optional database seeding
- ‚úÖ Non-root user for security
- ‚úÖ Unified .env template (works for both local dev & Docker)

**Services:**

- **app**: Node.js application on port 3000
- **postgres**: PostgreSQL database on port 5432
- **redis**: Redis cache on port 6379

**Quick Start:**

```bash
cp .env.example .env
# Edit .env with API keys (comment out DATABASE_URL/REDIS_URL for Docker)
docker-compose up --build
```

---

## üöß In Progress / Next Steps

### Phase 4: User Onboarding Flow (NEXT - Priority 1)

**To Create:**

1. `src/routes/auth/onboarding.tsx` - Multi-step preference form
2. `src/routes/api/preferences.ts` - API to save preferences
3. `src/components/PreferenceStep.tsx` - Reusable step component (optional)

**Requirements:**

- **Step 1: Genres** - Checkboxes for contemporary, paranormal, historical, fantasy
- **Step 2: Tropes** - Multi-select from common romance tropes
- **Step 3: Spice Level** - Slider or buttons (1-5, with descriptions)
- **Step 4: Pacing** - Radio buttons (slow-burn vs fast-paced)
- Progress indicator
- Save to `users.default_preferences` as JSONB
- Redirect to `/browse` on completion

**Trope Options to Include:**

- fake-dating, enemies-to-lovers, friends-to-lovers
- forced-proximity, second-chance, forbidden-love
- fated-mates, grumpy-sunshine, boss-employee
- small-town, billionaire, single-parent

**API Endpoint:**

```typescript
POST /api/preferences
Body: { genres: string[], tropes: string[], spiceLevel: 1-5, pacing: string }
Response: { success: true }
```

### Phase 5: Novel Template System (Priority 2)

**To Create:**

1. `src/routes/browse.tsx` - Browse templates page (protected route)
2. `src/routes/templates/$templateId.tsx` - Template detail page
3. `src/routes/api/templates.ts` - Get all templates
4. `src/routes/api/templates/$templateId.ts` - Get template details
5. `src/components/NovelCard.tsx` - Template card component
6. `src/components/ProtectedRoute.tsx` - Auth middleware

**NovelCard Component:**

- Display title, description, tropes
- Show gradient background (from template.cover_gradient)
- Estimated reading time
- "Start Reading" button
- Shows "Continue Reading" if user has active story

**Browse Page Features:**

- Grid layout of novel cards
- Filter by trope/genre
- User's active stories at top
- "New for you" section based on preferences

### Phase 6: Story Creation & Configuration (Priority 3)

**To Create:**

1. `src/routes/stories/new.tsx` - Story configuration page
2. `src/routes/api/stories/create.ts` - Create story endpoint
3. `src/components/PreferenceOverride.tsx` - Per-story preference adjustments

**Story Configuration:**

- Select template
- Option to override default preferences
- Preview template with choice points
- "Start Story" button creates user_story record

**Create Story Flow:**

1. User clicks "Start Reading" on template
2. Shows configuration page (optional preference override)
3. Creates record in `user_stories` table
4. Redirects to `/stories/$storyId/read`

### Phase 7: Reading Interface (Priority 4)

**To Create:**

1. `src/routes/stories/$storyId/read.tsx` - Main reading page
2. `src/routes/api/stories/$storyId/scene.ts` - Generate/fetch scene
3. `src/routes/api/stories/$storyId/choose.ts` - Record choice
4. `src/components/ReadingView.tsx` - Scene display component
5. `src/components/ChoiceSelector.tsx` - Choice options component
6. `src/components/ProgressBar.tsx` - Story progress indicator

**Reading Page Features:**

- Scene content in prose format (800-1200 words)
- Scene number indicator
- Progress bar (current scene / estimated scenes)
- Choice selector appears at choice points
- Loading state during AI generation
- Previous/Next scene navigation
- Return to library button

**Choice Selector:**

- 3 options displayed as cards
- Shows tone/impact hints
- Disabled until user selects
- "Continue" button to advance

**API Endpoints:**

```typescript
GET /api/stories/:storyId/scene?number=N
Response: { content: string, sceneNumber: number, choicePoint?: {...} }

POST /api/stories/:storyId/choose
Body: { choicePointId: string, selectedOption: number }
Response: { success: true, nextScene: number }
```

### Phase 8: Library & Management (Priority 5)

**To Create:**

1. `src/routes/library.tsx` - User's story library
2. `src/routes/api/stories.ts` - Get user's stories
3. `src/components/StoryCard.tsx` - Library story card
4. `src/components/StoryStats.tsx` - Statistics display

**Library Features:**

- Tabs: "In Progress" / "Completed"
- Story cards showing:
  - Template title
  - Progress (current scene / total)
  - Last read timestamp
  - Word count
  - "Continue Reading" / "Read Again" buttons
- Delete story option
- Story statistics

### Phase 9: Polish & UX (Priority 6)

**To Create:**

1. Error boundaries
2. Loading skeletons
3. Responsive layouts
4. Animations/transitions
5. Toast notifications
6. Empty states
7. 404 page
8. Settings page

**Improvements Needed:**

- Protected route middleware
- Better error handling
- User feedback (toasts)
- Mobile optimization
- Accessibility (ARIA labels)
- SEO metadata

---

## üîß Technical Debt & TODOs

### Security

- [ ] Add rate limiting (on API routes)
- [ ] Content moderation for AI-generated scenes
- [ ] Email verification flow
- [ ] Password reset flow
- [ ] CSRF token validation for forms

### Performance

- [ ] Scene pre-generation (background jobs)
- [ ] Redis for session storage (instead of DB)
- [ ] Image optimization (template covers)
- [ ] Code splitting for routes
- [ ] Database connection pooling optimization

### Testing

- [ ] Unit tests for authentication logic
- [ ] Integration tests for API routes
- [ ] E2E tests for user flows
- [ ] AI generation testing with mock fixtures

### DevOps

- [ ] Docker setup
- [ ] CI/CD pipeline
- [ ] Database backup strategy
- [ ] Monitoring and logging
- [ ] Error tracking (Sentry)

---

## üìù Implementation Notes

### Authentication Flow

```
1. User signs up ‚Üí Create user record ‚Üí Create session ‚Üí Redirect to /auth/onboarding
2. User completes onboarding ‚Üí Save preferences ‚Üí Redirect to /browse
3. User logs in ‚Üí Validate credentials ‚Üí Create session ‚Üí Check preferences
   - Has preferences? ‚Üí Redirect to /browse
   - No preferences? ‚Üí Redirect to /auth/onboarding
```

### Story Generation Flow

```
1. User selects template ‚Üí Configure preferences ‚Üí Create user_story
2. Navigate to /stories/:id/read ‚Üí Fetch scene 1 ‚Üí Check cache
   - Cached? ‚Üí Return from DB
   - Not cached? ‚Üí Generate with AI ‚Üí Save to DB ‚Üí Return
3. User reads ‚Üí Reaches choice point ‚Üí Select option ‚Üí Record choice
4. Advance to next scene ‚Üí Repeat step 2 with choice context
```

### Scene Caching Strategy

- Each scene cached in `scenes` table with unique (story_id, scene_number)
- On generation, last 2 scenes used as context
- Previous choice impacts next scene generation
- Cache never invalidated (deterministic based on choices)

### Preference Structure (JSONB)

```json
{
  "genres": ["contemporary", "paranormal"],
  "tropes": ["enemies-to-lovers", "forced-proximity"],
  "spiceLevel": 4,
  "pacing": "slow-burn",
  "protagonistTraits": ["sarcastic", "independent"],
  "settingPreferences": ["urban", "workplace"]
}
```

---

## üöÄ Quick Start Commands

```bash
# Install dependencies
pnpm install

# Setup database (after creating PostgreSQL database)
pnpm db:migrate
pnpm db:codegen
pnpm db:seed

# Development
pnpm dev

# Build for production
pnpm build
pnpm start
```

---

## üìä Current Status Summary

**Overall Progress**: ~50% (Phases 1-3 complete, 6 phases remaining)

**Can Currently Run**:

- ‚úÖ Landing page at `/`
- ‚úÖ Signup at `/auth/signup`
- ‚úÖ Login at `/auth/login`
- ‚úÖ Google OAuth flow
- ‚úÖ Session management working

**Cannot Yet Run**:

- ‚ùå Onboarding flow (needs to be built)
- ‚ùå Browse templates (needs to be built)
- ‚ùå Read stories (needs to be built)
- ‚ùå User library (needs to be built)

**Next Immediate Steps**:

1. Build onboarding page (`/auth/onboarding`)
2. Build browse page (`/browse`)
3. Build reading interface (`/stories/:id/read`)
4. Build library page (`/library`)

---

## üéØ Critical Path to MVP

To get a working MVP, implement in this order:

1. **Onboarding** (allows users to set preferences)
2. **Browse** (allows users to see templates)
3. **Story Creation** (allows users to start stories)
4. **Reading Interface** (allows users to read & choose)
5. **Library** (allows users to manage stories)

After these 5 components, the core loop is complete and the app is functional!

---

## üí° Future Enhancements (Post-MVP)

- Social features (share scenes, recommend stories)
- Custom template creation (user-submitted prompts)
- Multiple protagonist perspectives
- Story branching visualization
- Export as PDF/EPUB
- Mobile app (React Native)
- Subscription tiers (GPT-4 vs GPT-3.5)
- Community voting on templates
- AI narrator voices (text-to-speech)
- Illustrations at key moments

---

**Last Session Context**: Set up project foundation, database schema, authentication system, and AI integration. Ready to build user-facing features starting with onboarding.
